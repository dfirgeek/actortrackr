{% extends "layouts/base.html" %}
{% block container %}

{% if users %}
<div class="table-responsive">          
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Company</th>
                <th>Approved</th>
                <th>Write</th>
                <th>Delete</th>
                <th>Admin</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user['name']|e  }}</td>
                <td>
                    {{ user['email']|e  }}
                    {% if user['email_verified'] == 0 %}
                        <span style="color:red">(Not Verified)</span>
                    {% endif %}
                </td>
                <td>{{ user['company']|e  }}</td>
                <td align="center">
                    <button class="btn-xs {% if user['approved'] == 1 %}btn-success{% else %}btn-danger{% endif %} user-permission"  data-action="approve" data-user-id="{{ user['id'] }}" data-value="{% if user['approved'] == 1 %}0{% else %}1{% endif %}" data-user-c="{{ user['id_hash'] }}">&nbsp;</button>
                </td>
                <td align="center">
                    <button class="btn-xs {% if user['write_permission'] == 1 %}btn-success{% else %}btn-danger{% endif %} user-permission" data-action="write_perm" data-user-id="{{ user['id'] }}" data-value="{% if user['write_permission'] == 1 %}0{% else %}1{% endif %}" data-user-c="{{ user['id_hash'] }}">&nbsp;</button>
                </td>
                <td align="center">
                    <button class="btn-xs {% if user['delete_permission'] == 1 %}btn-success{% else %}btn-danger{% endif %} user-permission" data-action="delete_perm" data-user-id="{{ user['id'] }}" data-value="{% if user['delete_permission'] == 1 %}0{% else %}1{% endif %}" data-user-c="{{ user['id_hash'] }}">&nbsp;</button>
                </td>
                <td align="center">
                    <button class="btn-xs {% if user['admin'] == 1 %}btn-success{% else %}btn-danger{% endif %} user-permission" data-action="admin_perm" data-user-id="{{ user['id'] }}" data-value="{% if user['admin'] == 1 %}0{% else %}1{% endif %}" data-user-c="{{ user['id_hash'] }}">&nbsp;</button>
                </td>
                <td align="center">
                    <a href="/admin/user/delete/{{ user['id'] }}/{{ user['id_hash'] }}/?_r={{ url }}" data-toggle="tooltip" title="Delete" onclick="return confirm('Are you sure you wish to permanently delete {{ user['name'] }}')">
                        <button type="button" class="btn btn-default btn-xs">
                            <span class="glyphicon glyphicon-trash"></span> In Work
                        </button>
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="row">
    <div class="col-md-12">
        No results found
    </div>
</div>
{% endif %}

{% endblock %}

{% block javascript %}
<script>
$(document).ready(function(){

    $(".user-permission").click(function(){

        var action = $(this).data("action")
        var user_id = $(this).data("user-id")
        var user_value = $(this).data("value")
        var user_c = $(this).data("user-c")

        console.log(action + " " + user_id + " " + user_value + " " + user_c)
        
        var button = $(this)
        $.get( "/admin/user/"+action+"/" + user_value + "/" + user_id + "/" + user_c, function( data ) {
            if (data["success"] == 1){
                if (data['new_value'] == 1){
                    button.removeClass("btn-danger")
                    button.addClass("btn-success")
                    button.data("value", 0)
                }
                else{
                    button.removeClass("btn-success")
                    button.addClass("btn-danger")
                    button.data("value", 1)
                }
            }
            else{
                alert("There was an error completing your request.")
            }
        });
    })
});
</script>
{% endblock %}